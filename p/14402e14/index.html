<!DOCTYPE html><html><head><meta charset="utf-8"><title>MySQL之InnoDB | 曹耘豪的博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="alternate" href="/atom.xml" title="曹耘豪的博客" type="application/atom+xml"><link rel="icon" href="https://s1.ax1x.com/2018/06/09/CbgQqs.png"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="header2" style="border-bottom:1px solid #ccc"><input type="checkbox" id="header-menu-input"><h1 style="text-align:left"><a href="/">曹耘豪的博客</a> <label for="header-menu-input"><svg class="op open" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0 0 50 50" fill="currentcolor" stroke="currentcolor"><path d="M 0 7.5 L 0 12.5 L 50 12.5 L 50 7.5 Z M 0 22.5 L 0 27.5 L 50 27.5 L 50 22.5 Z M 0 37.5 L 0 42.5 L 50 42.5 L 50 37.5 Z"></path></svg> <svg class="close" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0 0 30 30" style="fill:red"><path d="M 7 4 C 6.744125 4 6.4879687 4.0974687 6.2929688 4.2929688 L 4.2929688 6.2929688 C 3.9019687 6.6839688 3.9019687 7.3170313 4.2929688 7.7070312 L 11.585938 15 L 4.2929688 22.292969 C 3.9019687 22.683969 3.9019687 23.317031 4.2929688 23.707031 L 6.2929688 25.707031 C 6.6839688 26.098031 7.3170313 26.098031 7.7070312 25.707031 L 15 18.414062 L 22.292969 25.707031 C 22.682969 26.098031 23.317031 26.098031 23.707031 25.707031 L 25.707031 23.707031 C 26.098031 23.316031 26.098031 22.682969 25.707031 22.292969 L 18.414062 15 L 25.707031 7.7070312 C 26.098031 7.3170312 26.098031 6.6829688 25.707031 6.2929688 L 23.707031 4.2929688 C 23.316031 3.9019687 22.682969 3.9019687 22.292969 4.2929688 L 15 11.585938 L 7.7070312 4.2929688 C 7.5115312 4.0974687 7.255875 4 7 4 z"></path></svg></label> <input disabled id="local-search-input" class="input-text" type="search" placeholder="js未开启，无法搜索" aria-label="Search"></h1><div id="local-search-result"></div><div class="header-menu" for="header-menu-input"><aside id="sidebar"><div><div class="widget-wrap widget-category"><h3 class="widget-title">目录</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/category/other/">其他</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/">技术</a><span class="category-list-count">137</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/category/technology/cpp/">C++</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/Go/">Go</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/java/">Java</a><span class="category-list-count">59</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/python/">Python</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/Rust/">Rust</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E5%89%8D%E7%AB%AF/">前端</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/machine-learning/">机器学习</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/computer-network/">计算机网络</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/design-pattern/">设计模式</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E8%AF%B4%E8%AF%B4/">说说</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">13</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/category/algorithm/">算法</a><span class="category-list-count">8</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">MySQL</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Protobuf/" rel="tag">Protobuf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Cloud/" rel="tag">Spring Cloud</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Feign/" rel="tag">Feign</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" rel="tag">问题排查</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nextjs/" rel="tag">Nextjs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">Spring</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/" rel="tag">JVM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%90%86/" rel="tag">代理</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gradle/" rel="tag">Gradle</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maven/" rel="tag">Maven</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fastjson/" rel="tag">fastjson</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/" rel="tag">node</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm/" rel="tag">npm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">缓存</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hive/" rel="tag">Hive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8B%E8%AF%95/" rel="tag">测试</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/" rel="tag">HBase</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/" rel="tag">响应式编程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">其他</h3><div class="widget"><a href="/atom.xml">RSS Feed </a><a href="/resume" style="margin-left:8px">Resume</a></div></div></div></aside></div><script src="/js/search.js"></script><script type="text/javascript">(()=>{var e="local-search-input",a=(($input=document.getElementById(e)).disabled=!1,$input.placeholder="全站本地搜索","search.json"),a="/"+(a=0===a.length?"search.json":a);searchFunc(a,e,"local-search-result")})()</script></div><article id="post-14402e14" class="article article-type-post" itemscope itemprop="blogPost" style="position:relative"><header><h1 class="article-title" itemprop="name">MySQL之InnoDB</h1></header><div class="secondary-bg" style="border:1px solid gray;border-radius:4px"><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#InnoDB%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-nav-text">InnoDB数据结构</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%B4%A2%E5%BC%95%E7%B1%BB%E5%9E%8B"><span class="toc-nav-text">索引类型</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95"><span class="toc-nav-text">聚簇索引</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%9D%9E%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95%EF%BC%88%E6%99%AE%E9%80%9A%E7%B4%A2%E5%BC%95%E3%80%81%E8%BE%85%E5%8A%A9%E7%B4%A2%E5%BC%95%EF%BC%89"><span class="toc-nav-text">非聚簇索引（普通索引、辅助索引）</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Change-Buffer"><span class="toc-nav-text">Change Buffer</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95"><span class="toc-nav-text">唯一索引</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95"><span class="toc-nav-text">联合索引</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%B4%A2%E5%BC%95%E6%A3%80%E7%B4%A2"><span class="toc-nav-text">索引检索</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-nav-text">索引失效</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95%E7%9A%84%E6%9C%80%E5%B7%A6%E5%8C%B9%E9%85%8D%E5%8E%9F%E5%88%99"><span class="toc-nav-text">联合索引的最左匹配原则</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%97%A5%E5%BF%97%E4%B8%8E%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4"><span class="toc-nav-text">日志与两阶段提交</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Redo-Log%EF%BC%88%E9%87%8D%E5%81%9A%E6%97%A5%E5%BF%97%EF%BC%89"><span class="toc-nav-text">Redo Log（重做日志）</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Log%E7%BB%93%E6%9E%84"><span class="toc-nav-text">Log结构</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-nav-text">文件结构</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#LSN%EF%BC%88log-sequence-number%EF%BC%89"><span class="toc-nav-text">LSN（log sequence number）</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%B7%E7%9B%98%E6%97%B6%E6%9C%BA"><span class="toc-nav-text">刷盘时机</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#binlog"><span class="toc-nav-text">binlog</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%86%99%E5%85%A5%E6%9C%BA%E5%88%B6"><span class="toc-nav-text">写入机制</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4"><span class="toc-nav-text">二阶段提交</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Undo-log%EF%BC%88%E5%9B%9E%E6%BB%9A%E6%97%A5%E5%BF%97%EF%BC%89"><span class="toc-nav-text">Undo log（回滚日志）</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84-1"><span class="toc-nav-text">文件结构</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="toc-nav-text">多版本并发控制</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#ReadView"><span class="toc-nav-text">ReadView</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%BF%AB%E7%85%A7%E8%AF%BB%E5%92%8C%E5%BD%93%E5%89%8D%E8%AF%BB"><span class="toc-nav-text">快照读和当前读</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%97%A5%E5%BF%97%E6%80%BB%E7%BB%93"><span class="toc-nav-text">日志总结</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Update%E5%92%8CDelete%E6%93%8D%E4%BD%9C%E7%9A%84%E5%86%85%E9%83%A8%E6%9C%BA%E5%88%B6"><span class="toc-nav-text">Update和Delete操作的内部机制</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%A3%81%E7%9B%98%E5%AD%98%E5%82%A8"><span class="toc-nav-text">磁盘存储</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#B-Tree%E7%BB%93%E6%9E%84"><span class="toc-nav-text">B+Tree结构</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%8F%82%E8%80%83"><span class="toc-nav-text">参考</span></a></li></ol></div><span id="more"></span><h2 id="InnoDB数据结构"><a href="#InnoDB数据结构" class="headerlink" title="InnoDB数据结构"></a>InnoDB数据结构</h2><ul><li><p>使用<code>PRIMARY KEY</code> or <code>UNIQUE NOT NULL</code>字段作为主键，如果都没有，则使用<strong>隐式主键（DB_ROW_ID）</strong></p><ul><li><code>_rowid</code>会映射<strong>数值主键</strong>或第一个<strong>唯一非空</strong>数值字段</li></ul></li><li><p>数据记录是以<strong>主键</strong>为顺序的单向链表。所以使用<strong>自增整数</strong>作为主键最好，新增数据都在最后</p></li></ul><h2 id="索引类型"><a href="#索引类型" class="headerlink" title="索引类型"></a>索引类型</h2><p><strong>聚簇索引</strong>和<strong>非聚簇索引</strong>都是<strong>B+Tree</strong>，区别是<strong>聚簇索引</strong>的叶子节点存放整行数据</p><h3 id="聚簇索引"><a href="#聚簇索引" class="headerlink" title="聚簇索引"></a>聚簇索引</h3><ul><li>叶子节点存放<strong>整行数据</strong>，查询可直接获取整行数据</li><li>一个表只有一个聚簇索引，默认是主键</li></ul><h3 id="非聚簇索引（普通索引、辅助索引）"><a href="#非聚簇索引（普通索引、辅助索引）" class="headerlink" title="非聚簇索引（普通索引、辅助索引）"></a>非聚簇索引（普通索引、辅助索引）</h3><ul><li>叶子节点存放<strong>索引列的值</strong>和<strong>聚簇索引键（通常是主键）</strong></li><li>如果查询的字段不止<strong>聚簇索引键</strong>和<strong>索引列</strong>，则需要<strong>回表</strong><ul><li>回表：根据<strong>聚簇索引键</strong>查询<strong>聚簇索引</strong>获取行的其他列数据</li><li>索引覆盖：非聚簇索引字段满足查询字段的需求</li></ul></li></ul><h4 id="Change-Buffer"><a href="#Change-Buffer" class="headerlink" title="Change Buffer"></a>Change Buffer</h4><p>用于存储SQL变更操作。每个变更都会对应一个数据页。仅适用于<strong>普通索引</strong></p><p>插入&#x2F;更新&#x2F;删除，使用<code>Change Buffer</code>条件：</p><ul><li>数据页不在内存（<code>Buffer Pool</code>）</li><li>不用返回修改后的数据</li><li><code>innodb_change_buffering</code>参数配置缓存哪些操作</li></ul><p><code>Change Buffer</code>合并时机：</p><ul><li>加载变更操作对应的数据页</li><li>后台定时</li><li>Buffer Pool空间不足，通过<code>innodb_change_buffer_max_size</code>参数设置</li><li>redo log满了</li><li>数据库正常关闭</li></ul><h3 id="唯一索引"><a href="#唯一索引" class="headerlink" title="唯一索引"></a>唯一索引</h3><ul><li>查询效率高。查询时，查询到第一个符合当前索引值时，查询便结束</li><li>插入效率较低，需先读取可能的数据页，判断是否存在，写入磁盘，没有change buffer<ul><li>如果数据页就在内存，则直接判断是否冲突</li></ul></li></ul><h3 id="联合索引"><a href="#联合索引" class="headerlink" title="联合索引"></a>联合索引</h3><p>对于联合索引(a, b, c)</p><ul><li>B+Tree是针对a列进行索引</li><li>叶子结点存放(a,b,c)列的值，当a相等时，b有序，当b相等时，c有序</li><li>相当于同时建立(a)、(a, b)、(a, b, c)索引</li></ul><h2 id="索引检索"><a href="#索引检索" class="headerlink" title="索引检索"></a>索引检索</h2><h3 id="索引失效"><a href="#索引失效" class="headerlink" title="索引失效"></a>索引失效</h3><p>以下情况不会使用索引：</p><ul><li><p><code>where</code>语句字段类型不一致</p><ul><li><code>where</code>里的字段类型和数据库类型不一致，MySQL会进行隐式的数据类型转换，使用内置转换函数</li><li>当左侧需要转换且唯一时，不影响索引。 比如数值类型&#x3D;字符类型时</li></ul></li><li><p><code>where</code>语句使用表达式。如<code>where age + 2 = 30</code></p></li><li><p><code>where</code>语句使用内置函数。如<code>where lefe(phone_number) = &#39;136&#39;</code></p></li><li><p><code>where</code>语句使用左模糊匹配</p><ul><li>右模糊匹配依然可以使用索引</li></ul></li><li><p><code>where</code>语句使用<code>or</code>，innodb不会使用索引</p><ul><li>可以使用<code>union</code>代替<code>or</code>，前提是<code>union</code>的查询列有索引</li></ul></li><li><p><code>where</code>语句使用<code>!=</code>或<code>&lt;&gt;</code></p></li><li><p><code>where</code>语句中<code>in</code>、<code>not in</code>是否失效取决于MySQL版本，<code>8.0</code>之后会用索引</p></li><li><p><code>where</code>语句包含<code>NULL</code>判断</p></li><li><p><code>order by</code>字段和<code>where</code>字段不属于同一个索引</p><ul><li>MySQL 每次查询只使用一个索引</li></ul></li><li><p><code>order by</code>字段和<code>where</code>属于同一联合索引但和索引顺序不同</p></li><li><p><code>order by</code>多个字段在同一个联合索引，但排序顺序不同，一个<code>ASC</code>，一个<code>DESC</code></p></li></ul><h3 id="联合索引的最左匹配原则"><a href="#联合索引的最左匹配原则" class="headerlink" title="联合索引的最左匹配原则"></a>联合索引的最左匹配原则</h3><p>必须按照索引定义从左到右匹配</p><p>比如，对于联合索引(a, b, c)</p><ul><li><code>a=1 and b=1 and c=1</code>：使用索引(a, b, c)</li><li><code>a=1 and b=1</code>：使用索引(a, b)</li><li><code>b=1 and a=1</code>：使用索引(a, b)，查询优化</li><li><code>a=1</code>：使用索引(a)</li><li><code>b=1 and c=1</code>：不能使用索引</li><li><code>a=1 and c=1</code>：使用索引(a)</li><li><code>a=1 and b=1 and c&gt;0</code>：使用索引(a, b,c)</li><li><code>a=1 and b&gt;0 and c=1</code>：使用索引(a, b)，原因当b有多个时，c无序<ul><li>当有范围查询时，后面字段的索引无效</li></ul></li></ul><h2 id="日志与两阶段提交"><a href="#日志与两阶段提交" class="headerlink" title="日志与两阶段提交"></a>日志与两阶段提交</h2><h3 id="Redo-Log（重做日志）"><a href="#Redo-Log（重做日志）" class="headerlink" title="Redo Log（重做日志）"></a>Redo Log（重做日志）</h3><p>redo log（重做日志）是InnoDB存储引擎独有的，它让MySQL拥有了崩溃恢复能力。</p><p>一个事务中，对数据库的每次修改会先写入redo log buffer，一次数据修改往往会有B+Tree的多个修改点，有多条redo log，称为<strong>Mini-Transaction</strong>（简写mtr），是写入的最小单元。每一组redo log结尾会有一个标志符，直到读到这个标志符这一组才完整，否则丢弃，保证mtr的原子性。</p><h4 id="Log结构"><a href="#Log结构" class="headerlink" title="Log结构"></a>Log结构</h4><p>{log block header，12字节} + {log block body} + {log block tralider，4字节}</p><h4 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h4><p>redo log不是只有一个文件（数量由<code>innoDB_log_files_in_group</code>指定），而是以<strong>redo日志文件组（redo log group）</strong>的形式，每个日志文件大小48M（由<code>Innodb_log_file_Size</code>指定），log文件每次以block为单位操作，每个block有512个字节</p><p>日志文件组每个文件大小一样，格式一样，由两个部分组成：</p><ul><li>前2048个字节（前4个block）存一些管理信息</li><li>之后其他，开始存log buffer的block</li></ul><p>记录时采用环形数组的方式，循环写这些文件，所以我们需要知道当前写入的位置和哪些日志已经写到磁盘了，由<code>log_sys</code>记录</p><ul><li><code>written_to_all_lsn</code>：已经写盘的的LSN（未flush）。并非每次生成log就写盘</li><li><code>flushed_to_disk_lsn</code>：记录已经flush的LSN。并非每次写盘都flush</li><li><code>buf_next_to_write</code>：buf中下一个要写入磁盘的位置</li><li><code>buf_free</code>：buf中实际内容的最后位置，<code>buf_next_to_write</code> &lt; <code>buf_free</code>时说明存在数据未写盘</li></ul><h4 id="LSN（log-sequence-number）"><a href="#LSN（log-sequence-number）" class="headerlink" title="LSN（log sequence number）"></a>LSN（log sequence number）</h4><p>LSN是一个单调递增的值，从<code>8704</code>开始，<strong>脏页</strong>（页被修改但未同步至磁盘）和redo log都有各自的LSN。</p><p>Buffer Pool里的脏页，是一个链表结构（<strong>Flush List</strong>）。第一次被修改的页，会以<strong>头插法</strong>的形式插入到表头，每个脏页都记录着第一次被修改的LSN（<code>123</code>）和最后一次被修改的LSN（<code>123</code>）。</p><h4 id="刷盘时机"><a href="#刷盘时机" class="headerlink" title="刷盘时机"></a>刷盘时机</h4><ul><li><p>InnoDB后台定时线程每隔1s刷盘</p></li><li><p>InnoDB提供<code>innodb_flush_log_at_trx_commit</code>参数配置事务刷盘策略</p><ul><li><p><code>0</code>：不主动落盘。MySQL挂了会丢失1s内数据</p></li><li><p><code>1</code>：事务提交时刷盘。默认</p></li><li><p><code>2</code>：事务提交时，写入page cache。操作系统宕机会丢1s内数据</p></li></ul></li><li><p>当redo log buffer大小达到<code>innodb_log_buffer_size</code>一半时</p></li></ul><h3 id="binlog"><a href="#binlog" class="headerlink" title="binlog"></a>binlog</h3><p>binlog是MySQL的Server层实现的，所有引擎都可以使用，有以下作用</p><ul><li>数据备份、恢复</li><li>主备、主主、主从复制</li></ul><p>binlog记录了这个语句的原始逻辑，格式有3个选项，通过<code>binlog_format</code>指定</p><ul><li><code>statement</code>：SQL原语句。问题是如果SQL中有当前时间相关的，会出现不一致</li><li><code>row</code>：二机制，需用<code>mysqlbinlog</code>解析，不会发生不一致，但比较占空间和IO</li><li><code>mixed</code>：MySQL判断是否会引起数据不一致，如果会，则用<code>row</code></li></ul><h4 id="写入机制"><a href="#写入机制" class="headerlink" title="写入机制"></a>写入机制</h4><ul><li>先写入bin cache，事务提交时，在写入文件（page cache）<ul><li><code>sync_binlog</code>：控制fsync时机<ul><li><code>0</code>：不主动，默认</li><li><code>1</code>：每次写入时</li><li><code>N</code>：每N次，N&gt;1</li></ul></li></ul></li><li>一个事务的binlog不能分开</li><li><code>binlog_cache_size</code>控制单个事务cache大小，超过这个大小，暂存到磁盘</li></ul><h3 id="二阶段提交"><a href="#二阶段提交" class="headerlink" title="二阶段提交"></a>二阶段提交</h3><p>redo log的写入分为两个阶段：<code>prepare</code>和<code>commit</code></p><p>写入流程：</p><ul><li>事务开始</li><li>缓存内更新数据</li><li>写入redo log，<strong>prepare</strong>阶段</li><li>提交事务，写入<strong>binlog</strong></li><li>redo log <strong>commit</strong>阶段</li><li>事务结束</li></ul><p>如果redo log commit阶段失败，由于有binlog，也认为事务完成</p><h3 id="Undo-log（回滚日志）"><a href="#Undo-log（回滚日志）" class="headerlink" title="Undo log（回滚日志）"></a>Undo log（回滚日志）</h3><p>Undo log也是InnoDB的一种日志。事务内所有的修改会先记录到undo log并落盘，如果事务执行过程异常，利用undo log回滚</p><ul><li>逻辑日志，提供相反操作</li><li>事务回滚</li><li>多版本并发控制（MVCC），InnoDB使用<strong>乐观锁</strong></li><li>insert、upate、delete会记录undo log</li><li>通过purge线程回收</li></ul><h4 id="文件结构-1"><a href="#文件结构-1" class="headerlink" title="文件结构"></a>文件结构</h4><ul><li>采用分段(segment)的方式存储，每个段有1024个undo log segment<ul><li>MySQL5.5之前，只支持1个rollback segment，只能记录1024个undo操作</li><li>MySQL5.5之后，可支持128个rollback segment，分别从resg slot0 ～ resg slot127</li><li><code>innodb_undo_tablespaces</code>：表空间，默认是0，公用表空间</li></ul></li><li>内容：<ul><li>Next：指向下一条Undo log</li><li>Undo Log类型：<code>Insert</code>和<code>Update</code></li><li>Undo No</li><li>事务ID（DATA_TRX_ID）</li><li>Table id：表ID</li><li>上一次回滚ID（DATA_ROLL_ID）<ul><li>指向上一个undo log的Undo No</li><li>假如前后发生事务A、B、C修改同一个字段name，则undo log的指向是，C的undo log指向B，如果C回滚会回滚到B的值，如果B回滚，则回滚到A的值</li></ul></li><li>其他 <a href="https://zhuanlan.zhihu.com/p/165457904">https://zhuanlan.zhihu.com/p/165457904</a></li></ul></li></ul><h3 id="多版本并发控制"><a href="#多版本并发控制" class="headerlink" title="多版本并发控制"></a>多版本并发控制</h3><h4 id="ReadView"><a href="#ReadView" class="headerlink" title="ReadView"></a>ReadView</h4><p>read view 是实现 MVCC 的关键，描述的是在该事务开始时刻数据库系统中所有事务的总体状态。</p><p>在新事务开始时，会存在一个已提交事务 T，在其之前的事务都已提交。该事务只能看到 T 及其之前事务的影响（事务 T 提交时刻数据库的 snapshot）</p><p>例如，此时的事务提交情况如下，当前事务是<code>7</code>，事务开始时，复制当前的事务总体状况<code>m_ids=[5, 8, 9]</code>，此时最大事务已经<code>max_trx_id=10</code>，所以，<code>m_up_limit_id=5</code>，<code>m_low_limit_id=10</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">trx_id: 1 2 3 4 5 6 7 8 9 *10 11 12</span><br><span class="line">state : 1 1 1 1 0 0 _ 1 0   0  1  0</span><br><span class="line">// 0代表正在进行的事务，1代表事务完成</span><br></pre></td></tr></table></figure><p>对于事务7，当前正在进行的事务是</p><ul><li>所有大于等于<code>m_low_limit_id</code>(10)的事务，[10, 11]</li><li>所有大于等于<code>m_up_limit_id</code>(5)<strong>且</strong>在m_ids内，[5, 6, 9, 10]</li></ul><p>对于事务7，已经提交的事务是</p><ul><li>所有小于<code>m_up_limit_id</code>(5)的事务，[1, 2, 3, 4]</li><li>所有大于等于<code>m_up_limit_id</code>(5)<strong>且</strong>小于等于<code>m_low_limit_id</code>(10)<strong>且</strong>不在m_ids内的，[8]</li></ul><p>综上，对于事务7，可见的事务为[1, 2, 3, 4, 8]，就是在7开始时已经提交的事务</p><p>数据的隐藏列<code>DATA_TRX_ID</code>记录当前该行的事务ID，当该行的事务对其（事务7）不可见时，使用数据隐藏列<code>DB_ROLL_ID</code>回溯undo log直到可见</p><ul><li>假设事务4插入一条数据（<code>name=&quot;Tom&quot;</code>），此时<code>DATA_TRX_ID=4</code>，提交</li><li>事务5修改该行（<code>name=&quot;Jerry&quot;</code>），生成undo log（<code>undo no=1 DATA_TRX_ID=4 name=&quot;Tom&quot;</code>），此时<code>DATA_TRX_ID=5, DB_ROLL_ID=1</code></li><li>对于事务7来说，事务5还未提交，此时不应该读到”Jerry”，事务7判断该行的<code>DATA_TRX_ID</code>不在可见范围内，就通过<code>DB_ROLL_ID=1</code>找到<code>undo no=1</code>的undo log，看此时<code>DATA_TRX_ID=4</code>在自己的可见范围，则读到Tom</li></ul><h4 id="快照读和当前读"><a href="#快照读和当前读" class="headerlink" title="快照读和当前读"></a>快照读和当前读</h4><p><strong>快照读</strong>（SnapShot Read）是一种<strong>一致性不加锁的读</strong> ，是InnoDB并发如此之高的核心原因之一</p><blockquote><p>这里的一致性是指，事务读取到的数据，要么是事务开始前就已经存在的数据 ，要么是事务自身插入或者修改过的数据</p></blockquote><p>不加锁的简单<code>SELECT</code>都属于快照读，例如：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>`</span><br></pre></td></tr></table></figure><p>与快照读相对应的则是<strong>当前读</strong>， 当前读就是读取最新数据，而不是历史版本的数据。加锁的<code>SELECT</code>就属于当前读，例如：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span> LOCK <span class="keyword">IN</span> SHARE MODE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><h3 id="日志总结"><a href="#日志总结" class="headerlink" title="日志总结"></a>日志总结</h3><p>MySQL InnoDB引擎使用<strong>redo log</strong>保证事务的<strong>持久性</strong>，使用<strong>undo log</strong>来保证事务的<strong>原子性</strong></p><p>MySQL数据库的<strong>数据备份</strong>、<strong>主备</strong>、<strong>主主</strong>、<strong>主从</strong>都离不开<strong>binlog</strong>，需要依靠<strong>binlog</strong>来同步数据，保证数据一致性</p><h2 id="Update和Delete操作的内部机制"><a href="#Update和Delete操作的内部机制" class="headerlink" title="Update和Delete操作的内部机制"></a>Update和Delete操作的内部机制</h2><p>update分为两种情况</p><ul><li>如果不是主键列，在undo log中直接反向记录是如何update的</li><li>如果是主键列，update分两部执行：先删除该行，再插入一行目标行</li></ul><p>delete操作实际上不会直接删除，而是将delete对象打上delete flag，标记为删除，最终的删除操作是<strong>purge线程</strong>完成的</p><h2 id="磁盘存储"><a href="#磁盘存储" class="headerlink" title="磁盘存储"></a>磁盘存储</h2><p>MySQL一次IO读取的数据称之为一<strong>页</strong>，每页默认是<strong>16KB</strong>。指针(64位,8B)+值(bigint,8B)&#x3D;16B，16KB&#x2F;16B&#x3D;1K个键值，两层就是1K*1K&#x3D;100w条记录，对于100w记录的表两次IO即可找到对应的位置</p><p>磁盘IO，磁盘读取数据靠的是机械运动，每一次读取数据需要<strong>寻道</strong>、<strong>寻点</strong>、<strong>拷贝到内存</strong>三步操作，平均需要<strong>10ms</strong>左右</p><h2 id="B-Tree结构"><a href="#B-Tree结构" class="headerlink" title="B+Tree结构"></a>B+Tree结构</h2><p>BTree，又叫<strong>多路平衡查找树</strong>，一颗m叉的BTree特性如下：</p><ul><li>树中每个节点最多包含m个孩子</li><li>除根节点与叶子节点外，每个节点至少有ceil(m &#x2F; 2)个孩子（ceil为向上取整）</li><li>若根节点不是叶子节点，则至少有两个孩子</li><li>所有的叶子节点都在同一层</li><li>每个非叶子节点由n个key与n+1个指针组成，其中ceil(m&#x2F;2)-1 &lt;&#x3D; n &lt;&#x3D; m-1</li></ul><p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/uChmeeX1FpyeHJZwK0jOlicB72AqSldRrhtQWiaBRz65Q1jWgNQGnd3KHOFRqibz7asHxaa96bUGdrRu159pDuu3A/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://blog.csdn.net/popofzk/article/details/122909645">https://blog.csdn.net/popofzk/article/details/122909645</a></li><li><a href="https://blog.csdn.net/cristianoxm/article/details/121957011">https://blog.csdn.net/cristianoxm/article/details/121957011</a></li><li><a href="https://www.modb.pro/db/436027">https://www.modb.pro/db/436027</a></li><li><a href="https://www.zhihu.com/question/345657290">https://www.zhihu.com/question/345657290</a></li><li><a href="https://zhuanlan.zhihu.com/p/442802131">https://zhuanlan.zhihu.com/p/442802131</a></li><li><a href="https://javaguide.cn/database/mysql/mysql-logs.html">https://javaguide.cn/database/mysql/mysql-logs.html</a></li><li><a href="https://developer.aliyun.com/article/8829">https://developer.aliyun.com/article/8829</a></li><li><a href="https://zhuanlan.zhihu.com/p/272696187">https://zhuanlan.zhihu.com/p/272696187</a></li><li>《MySQL的undo log》<a href="https://zhuanlan.zhihu.com/p/421358988">https://zhuanlan.zhihu.com/p/421358988</a></li><li>《InnoDB：undo log（2）》<a href="https://zhuanlan.zhihu.com/p/263038786">https://zhuanlan.zhihu.com/p/263038786</a></li></ul><div style="border-top:2px solid #eee;height:1px;margin:8px 0"></div><div class="article-category"><svg class="i-tag" width="16px" height="16px" viewBox="0 0 24 24" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.41959 3.23866C6.23018 3.05852 7.19557 3 8.312 3H9.92963C10.9327 3 11.8694 3.5013 12.4258 4.3359L13.2383 5.5547C13.4238 5.83288 13.736 6 14.0704 6H19.1258C20.7233 6 22.0181 7.26115 22.0029 8.8852C21.9847 10.8192 22 12.7539 22 14.688C22 15.8044 21.9415 16.7698 21.7613 17.5804C21.5787 18.4024 21.2579 19.1251 20.6915 19.6915C20.1251 20.2579 19.4024 20.5787 18.5804 20.7613C17.7698 20.9415 16.8044 21 15.688 21H8.312C7.19557 21 6.23018 20.9415 5.41959 20.7613C4.59764 20.5787 3.87488 20.2579 3.30848 19.6915C2.74209 19.1251 2.42133 18.4024 2.23866 17.5804C2.05852 16.7698 2 15.8044 2 14.688V9.312C2 8.19557 2.05852 7.23018 2.23866 6.41959C2.42133 5.59764 2.74209 4.87488 3.30848 4.30848C3.87488 3.74209 4.59764 3.42133 5.41959 3.23866ZM8.19103 13.8535C8.05868 14.449 8 15.2412 8 16.312V18C8 18.5523 7.55228 19 7 19C6.44772 19 6 18.5523 6 18V16.312C6 15.1956 6.05852 14.2302 6.23866 13.4196C6.42133 12.5976 6.74209 11.8749 7.30848 11.3085C7.87488 10.7421 8.59764 10.4213 9.41959 10.2387C10.2302 10.0585 11.1956 10 12.312 10H17.688H19C19.5523 10 20 10.4477 20 11C20 11.5523 19.5523 12 19 12H17.688H12.312C11.2412 12 10.449 12.0587 9.85349 12.191C9.26933 12.3209 8.9375 12.5079 8.72269 12.7227C8.50789 12.9375 8.32085 13.2693 8.19103 13.8535Z"/></svg> &nbsp; <a class="article-category-link" href="/category/technology/">技术</a>&nbsp;/&nbsp;<a class="article-category-link" href="/category/technology/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></div><div class="article-tag"><svg class="i-tag" width="16" height="16" viewBox="0 0 24 24" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2.678 11.422a2.5 2.5 0 0 0 0 3.536l6.364 6.364a2.5 2.5 0 0 0 3.536 0l7.69-7.69A2.5 2.5 0 0 0 21 11.864V4.5A1.5 1.5 0 0 0 19.5 3h-7.365a2.5 2.5 0 0 0-1.768.732l-7.69 7.69zM14.988 7C13.878 7 13 7.832 13 8.988c0 1.157.878 2.012 1.988 2.012C16.121 11 17 10.145 17 8.988 17 7.832 16.12 7 14.988 7z"/></svg> &nbsp; <a class="article-tag-link" href="/tags/mysql/" rel="tag">MySQL</a>, <a class="article-tag-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></div><div class="article-date"><time datetime="2022-12-07T14:00:00.000Z" itemprop="datePublished">2022-12-07</time></div></article></body></html>