<!DOCTYPE html><html><head><meta charset="utf-8"><title>微服务下的系统设计（更新中） | 曹耘豪的博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="alternate" href="/atom.xml" title="曹耘豪的博客" type="application/atom+xml"><link rel="icon" href="https://s1.ax1x.com/2018/06/09/CbgQqs.png"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="header2" style="border-bottom:1px solid #ccc"><input type="checkbox" id="header-menu-input"><h1 style="text-align:left"><a href="/">曹耘豪的博客</a> <label for="header-menu-input"><svg class="op open" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0 0 50 50" fill="currentcolor" stroke="currentcolor"><path d="M 0 7.5 L 0 12.5 L 50 12.5 L 50 7.5 Z M 0 22.5 L 0 27.5 L 50 27.5 L 50 22.5 Z M 0 37.5 L 0 42.5 L 50 42.5 L 50 37.5 Z"></path></svg> <svg class="close" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0 0 30 30" style="fill:red"><path d="M 7 4 C 6.744125 4 6.4879687 4.0974687 6.2929688 4.2929688 L 4.2929688 6.2929688 C 3.9019687 6.6839688 3.9019687 7.3170313 4.2929688 7.7070312 L 11.585938 15 L 4.2929688 22.292969 C 3.9019687 22.683969 3.9019687 23.317031 4.2929688 23.707031 L 6.2929688 25.707031 C 6.6839688 26.098031 7.3170313 26.098031 7.7070312 25.707031 L 15 18.414062 L 22.292969 25.707031 C 22.682969 26.098031 23.317031 26.098031 23.707031 25.707031 L 25.707031 23.707031 C 26.098031 23.316031 26.098031 22.682969 25.707031 22.292969 L 18.414062 15 L 25.707031 7.7070312 C 26.098031 7.3170312 26.098031 6.6829688 25.707031 6.2929688 L 23.707031 4.2929688 C 23.316031 3.9019687 22.682969 3.9019687 22.292969 4.2929688 L 15 11.585938 L 7.7070312 4.2929688 C 7.5115312 4.0974687 7.255875 4 7 4 z"></path></svg></label> <input disabled id="local-search-input" class="input-text" type="search" placeholder="js未开启，无法搜索" aria-label="Search"></h1><div id="local-search-result"></div><div class="header-menu" for="header-menu-input"><aside id="sidebar"><div><div class="widget-wrap widget-category"><h3 class="widget-title">目录</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/category/other/">其他</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/">技术</a><span class="category-list-count">137</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/category/technology/cpp/">C++</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/Go/">Go</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/java/">Java</a><span class="category-list-count">59</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/python/">Python</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/Rust/">Rust</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E5%89%8D%E7%AB%AF/">前端</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/machine-learning/">机器学习</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/computer-network/">计算机网络</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/design-pattern/">设计模式</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E8%AF%B4%E8%AF%B4/">说说</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">13</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/category/algorithm/">算法</a><span class="category-list-count">8</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">MySQL</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Protobuf/" rel="tag">Protobuf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Cloud/" rel="tag">Spring Cloud</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Feign/" rel="tag">Feign</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" rel="tag">问题排查</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nextjs/" rel="tag">Nextjs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">Spring</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/" rel="tag">JVM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%90%86/" rel="tag">代理</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gradle/" rel="tag">Gradle</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maven/" rel="tag">Maven</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fastjson/" rel="tag">fastjson</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/" rel="tag">node</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm/" rel="tag">npm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">缓存</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hive/" rel="tag">Hive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8B%E8%AF%95/" rel="tag">测试</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/" rel="tag">HBase</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/" rel="tag">响应式编程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">其他</h3><div class="widget"><a href="/atom.xml">RSS Feed </a><a href="/resume" style="margin-left:8px">Resume</a></div></div></div></aside></div><script src="/js/search.js"></script><script type="text/javascript">(()=>{var e="local-search-input",a=(($input=document.getElementById(e)).disabled=!1,$input.placeholder="全站本地搜索","search.json"),a="/"+(a=0===a.length?"search.json":a);searchFunc(a,e,"local-search-result")})()</script></div><article id="post-4c200748" class="article article-type-post" itemscope itemprop="blogPost" style="position:relative"><header><h1 class="article-title" itemprop="name">微服务下的系统设计（更新中）</h1></header><div class="secondary-bg" style="border:1px solid gray;border-radius:4px"><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8B%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%9C%E7%9A%84%E4%B8%8D%E7%A1%AE%E5%AE%9A%E6%80%A7%E2%80%94%E2%80%94%E8%B6%85%E6%97%B6"><span class="toc-nav-text">微服务下同步调用结果的不确定性——超时</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E4%BD%BF%E7%94%A8%E2%80%9C%E8%BF%87%E7%A8%8B%EF%BC%88pending%EF%BC%89%E2%80%9D"><span class="toc-nav-text">使用“过程（pending）”</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%B9%82%E7%AD%89%E8%AE%BE%E8%AE%A1"><span class="toc-nav-text">幂等设计</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8B%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2"><span class="toc-nav-text">微服务下的数据查询</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#API%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F"><span class="toc-nav-text">API组合模式</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#CQRS"><span class="toc-nav-text">CQRS</span></a></li></ol></li></ol></div><blockquote><p>记录一下微服务架构下的一些设计方案</p></blockquote><h3 id="微服务下同步调用结果的不确定性——超时"><a href="#微服务下同步调用结果的不确定性——超时" class="headerlink" title="微服务下同步调用结果的不确定性——超时"></a>微服务下同步调用结果的不确定性——超时</h3><p>基于网络波动的超时在所难免，我们不能因为超时便认为下游处理失败。</p><p>这里假设A服务调用B服务，最需要注意的场景是：</p><ul><li>B服务收到请求处理成功，在响应时超时，或者被A服务超时中断，A系统此时无法确认B是否受理和处理成功</li></ul><h4 id="使用“过程（pending）”"><a href="#使用“过程（pending）”" class="headerlink" title="使用“过程（pending）”"></a>使用“过程（pending）”</h4><p>因为A服务在超时时无法确认B的状态，所以我们需要补偿逻辑，使用“查询”，B系统提供查询接口，用于A查询刚刚的请求是否成功</p><ul><li>A –&gt; B: 请求（创建资源），此时B响应超时<ul><li>A将其标记为“进行中（pending）”</li></ul></li><li>A –&gt; B: 定时查询请求处理状态（查询pending资源是否已创建）<ul><li>返回不存在或成功、处理中、失败等状态，A将状态标记为“最终状态”，进行后续流程</li></ul></li></ul><p>为了支持后续的查询，A在第一次请求时，入参需要传递一个<strong>唯一请求号</strong>，B的查询接口入参为该唯一请求号</p><h4 id="幂等设计"><a href="#幂等设计" class="headerlink" title="幂等设计"></a>幂等设计</h4><p>在微服务环境下，请求出现重复非常正常，所以服务支持幂等非常重要。</p><p>在RPC请求里增加“唯一请求号”让我们在实现幂等上更加简单。</p><h3 id="微服务下的数据查询"><a href="#微服务下的数据查询" class="headerlink" title="微服务下的数据查询"></a>微服务下的数据查询</h3><p>客户端所需展示的数据，往往分散在各个微服务的存储内，我们无法使用简单的一次join就取出所有字段</p><h4 id="API组合模式"><a href="#API组合模式" class="headerlink" title="API组合模式"></a>API组合模式</h4><p>最常见和<em>首选</em>的方案是API组合模式，比如先查询主要条目，然后根据条目内关联的id，<em>批量</em>查询其他关联数据</p><p>这种模式实现较为简单，也会出现一些问题</p><ul><li>降低可用性。同步的API调用增加了服务间的依赖、增加了服务耦合，除非我们可以<em>缺少字段</em>或<em>提供默认字段</em>的响应给到客户端</li><li>状态不一致。即使时同步调用，不同服务间存储的某些公有属性可能不一致，需要API组合方决定如何处理</li></ul><h4 id="CQRS"><a href="#CQRS" class="headerlink" title="CQRS"></a>CQRS</h4><p>还有一种方案是CQRS，数据的读取和写入使用不同的Schema，甚至是不同的服务，基于<strong>事件驱动</strong>进行<em>读视图</em>的数据更新，保持最终一致性</p><p>这种方式缺点也比较明显：增加复杂性和开发成本、排查问题比较困难、同步延迟等</p><div style="border-top:2px solid #eee;height:1px;margin:8px 0"></div><div class="article-category"><svg class="i-tag" width="16px" height="16px" viewBox="0 0 24 24" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.41959 3.23866C6.23018 3.05852 7.19557 3 8.312 3H9.92963C10.9327 3 11.8694 3.5013 12.4258 4.3359L13.2383 5.5547C13.4238 5.83288 13.736 6 14.0704 6H19.1258C20.7233 6 22.0181 7.26115 22.0029 8.8852C21.9847 10.8192 22 12.7539 22 14.688C22 15.8044 21.9415 16.7698 21.7613 17.5804C21.5787 18.4024 21.2579 19.1251 20.6915 19.6915C20.1251 20.2579 19.4024 20.5787 18.5804 20.7613C17.7698 20.9415 16.8044 21 15.688 21H8.312C7.19557 21 6.23018 20.9415 5.41959 20.7613C4.59764 20.5787 3.87488 20.2579 3.30848 19.6915C2.74209 19.1251 2.42133 18.4024 2.23866 17.5804C2.05852 16.7698 2 15.8044 2 14.688V9.312C2 8.19557 2.05852 7.23018 2.23866 6.41959C2.42133 5.59764 2.74209 4.87488 3.30848 4.30848C3.87488 3.74209 4.59764 3.42133 5.41959 3.23866ZM8.19103 13.8535C8.05868 14.449 8 15.2412 8 16.312V18C8 18.5523 7.55228 19 7 19C6.44772 19 6 18.5523 6 18V16.312C6 15.1956 6.05852 14.2302 6.23866 13.4196C6.42133 12.5976 6.74209 11.8749 7.30848 11.3085C7.87488 10.7421 8.59764 10.4213 9.41959 10.2387C10.2302 10.0585 11.1956 10 12.312 10H17.688H19C19.5523 10 20 10.4477 20 11C20 11.5523 19.5523 12 19 12H17.688H12.312C11.2412 12 10.449 12.0587 9.85349 12.191C9.26933 12.3209 8.9375 12.5079 8.72269 12.7227C8.50789 12.9375 8.32085 13.2693 8.19103 13.8535Z"/></svg> &nbsp; <a class="article-category-link" href="/category/technology/">技术</a>&nbsp;/&nbsp;<a class="article-category-link" href="/category/technology/%E8%AF%B4%E8%AF%B4/">说说</a></div><div class="article-date"><time datetime="2025-03-02T02:00:00.000Z" itemprop="datePublished">2025-03-02</time></div></article></body></html>