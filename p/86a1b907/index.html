<!DOCTYPE html><html><head><meta charset="utf-8"><title>Redis基础 | 曹耘豪的博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="alternate" href="/atom.xml" title="曹耘豪的博客" type="application/atom+xml"><link rel="icon" href="https://s1.ax1x.com/2018/06/09/CbgQqs.png"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="header2" style="border-bottom:1px solid #ccc"><input type="checkbox" id="header-menu-input"><h1 style="text-align:left"><a href="/">曹耘豪的博客</a> <label for="header-menu-input"><svg class="op open" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0 0 50 50" fill="currentcolor" stroke="currentcolor"><path d="M 0 7.5 L 0 12.5 L 50 12.5 L 50 7.5 Z M 0 22.5 L 0 27.5 L 50 27.5 L 50 22.5 Z M 0 37.5 L 0 42.5 L 50 42.5 L 50 37.5 Z"></path></svg> <svg class="close" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0 0 30 30" style="fill:red"><path d="M 7 4 C 6.744125 4 6.4879687 4.0974687 6.2929688 4.2929688 L 4.2929688 6.2929688 C 3.9019687 6.6839688 3.9019687 7.3170313 4.2929688 7.7070312 L 11.585938 15 L 4.2929688 22.292969 C 3.9019687 22.683969 3.9019687 23.317031 4.2929688 23.707031 L 6.2929688 25.707031 C 6.6839688 26.098031 7.3170313 26.098031 7.7070312 25.707031 L 15 18.414062 L 22.292969 25.707031 C 22.682969 26.098031 23.317031 26.098031 23.707031 25.707031 L 25.707031 23.707031 C 26.098031 23.316031 26.098031 22.682969 25.707031 22.292969 L 18.414062 15 L 25.707031 7.7070312 C 26.098031 7.3170312 26.098031 6.6829688 25.707031 6.2929688 L 23.707031 4.2929688 C 23.316031 3.9019687 22.682969 3.9019687 22.292969 4.2929688 L 15 11.585938 L 7.7070312 4.2929688 C 7.5115312 4.0974687 7.255875 4 7 4 z"></path></svg></label> <input disabled id="local-search-input" class="input-text" type="search" placeholder="js未开启，无法搜索" aria-label="Search"></h1><div id="local-search-result"></div><div class="header-menu" for="header-menu-input"><aside id="sidebar"><div><div class="widget-wrap widget-category"><h3 class="widget-title">目录</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/category/other/">其他</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/">技术</a><span class="category-list-count">137</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/category/technology/cpp/">C++</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/Go/">Go</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/java/">Java</a><span class="category-list-count">59</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/python/">Python</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/Rust/">Rust</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E5%89%8D%E7%AB%AF/">前端</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/machine-learning/">机器学习</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/computer-network/">计算机网络</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/design-pattern/">设计模式</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E8%AF%B4%E8%AF%B4/">说说</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">13</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/category/algorithm/">算法</a><span class="category-list-count">8</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">MySQL</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Protobuf/" rel="tag">Protobuf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Cloud/" rel="tag">Spring Cloud</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Feign/" rel="tag">Feign</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" rel="tag">问题排查</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nextjs/" rel="tag">Nextjs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">Spring</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/" rel="tag">JVM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%90%86/" rel="tag">代理</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gradle/" rel="tag">Gradle</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maven/" rel="tag">Maven</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fastjson/" rel="tag">fastjson</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/" rel="tag">node</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm/" rel="tag">npm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">缓存</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hive/" rel="tag">Hive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8B%E8%AF%95/" rel="tag">测试</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/" rel="tag">HBase</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/" rel="tag">响应式编程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">其他</h3><div class="widget"><a href="/atom.xml">RSS Feed </a><a href="/resume" style="margin-left:8px">Resume</a></div></div></div></aside></div><script src="/js/search.js"></script><script type="text/javascript">(()=>{var e="local-search-input",a=(($input=document.getElementById(e)).disabled=!1,$input.placeholder="全站本地搜索","search.json"),a="/"+(a=0===a.length?"search.json":a);searchFunc(a,e,"local-search-result")})()</script></div><article id="post-86a1b907" class="article article-type-post" itemscope itemprop="blogPost" style="position:relative"><header><h1 class="article-title" itemprop="name">Redis基础</h1></header><div class="secondary-bg" style="border:1px solid gray;border-radius:4px"><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-nav-text">Redis数据结构</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Redis%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5"><span class="toc-nav-text">Redis过期策略</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Redis%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5"><span class="toc-nav-text">Redis内存淘汰策略</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Redis%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-nav-text">Redis持久化</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Redis%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88"><span class="toc-nav-text">Redis高可用方案</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#1-%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84"><span class="toc-nav-text">1. 主从架构</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#2-%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%EF%BC%88sentinel%EF%BC%8C%E5%9F%BA%E4%BA%8E%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%EF%BC%89"><span class="toc-nav-text">2. 哨兵模式（sentinel，基于主从架构）</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#3-Redis-Cluster"><span class="toc-nav-text">3. Redis Cluster</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E5%93%88%E5%B8%8C%E6%A7%BD"><span class="toc-nav-text">哈希槽</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E9%87%8D%E5%AE%9A%E5%90%91MOVED"><span class="toc-nav-text">重定向MOVED</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Redis%E5%91%BD%E4%BB%A4"><span class="toc-nav-text">Redis命令</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Redis%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-nav-text">Redis常见问题</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%83%AD%E7%82%B9Key%E9%97%AE%E9%A2%98"><span class="toc-nav-text">热点Key问题</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%A4%A7key%E5%88%A0%E9%99%A4"><span class="toc-nav-text">大key删除</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Redis-7%E7%9A%84ACL%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="toc-nav-text">Redis 7的ACL权限控制</span></a></li></ol></div><span id="more"></span><h3 id="Redis数据结构"><a href="#Redis数据结构" class="headerlink" title="Redis数据结构"></a>Redis数据结构</h3><blockquote><p><a href="https://blog.csdn.net/mz474920631/article/details/125200050">https://blog.csdn.net/mz474920631/article/details/125200050</a></p></blockquote><ul><li><strong>String</strong>：字符串。实现方式：动态字符串（SDS, Simple Dynamic String）<ul><li>SDS 通过预分配空间和惰性释放来优化内存使用</li></ul></li><li><strong>List</strong>：列表。实现方式：<strong>压缩列表(ziplist)<strong>、</strong>双向链表</strong>、<strong>quicklist</strong><ul><li>双向链表：内存不连续，内存开销大，无法利用CPU缓存</li><li>压缩列表：不能保存过多的元素，新增或修改时内存空间重新分配，可能引发连锁更新<ul><li><code>prevlen</code>：前一个节点的长度。如果前一个节点长度小于<code>254</code>个字节，则该字段保存使用<code>1</code>字节，如果大于等于<code>254</code>字节，则使用<code>5</code>字节保存</li><li><strong>连锁更新</strong>：如果插入或修改一个元素，导致其大小大于等于<code>254</code>字节，则其后面节点的<code>prevlen</code>需使用<code>5</code>字节保存，可能也导致再后面的节点长度扩大，从而导致连锁更新</li></ul></li><li>quicklist：双向链表 + 压缩列表的组合<ul><li>控制每个<strong>压缩列表</strong>的元素数量避免连锁更新</li><li>插入时，先判断是否能直接保存在压缩列表，如果不能，再新建一个节点</li><li>并没有彻底解决连锁更新问题</li></ul></li></ul></li><li><strong>Hash</strong>：哈希表。<strong>压缩列表(ziplist)<strong>、</strong>哈希表</strong>、<strong>listpack</strong><ul><li>哈希冲突严重触发<strong>渐进式</strong><code>rehash</code><ul><li>rehash期间，在访问一个哈希桶时，也将该哈希桶的所有key value迁移到hash2，以避免一次性操作；新增时，直接添加到hash2，最终hash1表变成空表，然后交换</li><li>触发时机：<strong>负载因子</strong>&#x3D;保存的节点数&#x2F;哈希桶大小，大于<code>1</code>时，如果没有<code>bgsave</code>和<code>bgrewriteaof</code>则触发，大于<code>5</code>时，强制触发</li></ul></li><li>listpack：不再记录前一个节点长度，彻底解决连锁更新问题</li><li>使用：计数布隆过滤器，支持元素删除</li><li>优化：<ul><li>对于field比较多的大key，使用<code>hscan</code>和<code>hmget</code>代替<code>hgetall</code>：需要注意，hscan的count参数是否有效，取决于此时hash的实现方式，如果field数量比较小，则count参数不生效 <a href="https://redis.io/docs/latest/commands/scan/">https://redis.io/docs/latest/commands/scan/</a></li></ul></li></ul></li><li><strong>Set</strong>：实现方式：<strong>哈希表</strong>、<strong>整数集合</strong><ul><li>整数集合：元素为整数且数量不大</li></ul></li><li><strong>ZSet</strong>：有序Set。实现方式：<strong>压缩列表(ziplist)<strong>、</strong>跳表(skiplist)<strong>、</strong>listpack</strong><ul><li>每个元素有一个<code>score</code>属性，按<code>score</code>从小到大排序</li><li>当键值对少于128个且元素长度小于64时使用<code>ziplist</code></li><li><code>ZADD</code>命令：<code>ZADD key score member</code></li><li><code>ZINCRBY</code>命令：<code>ZINCRBY key increment member</code></li><li>应用：<ul><li>延时队列（score为时间戳）：<ul><li><code>zadd q 100 a 200 b 300 c</code></li><li><code>zrange q 100 250 byscore</code> &#x3D;&gt; <code>a b</code></li></ul></li><li>语义前缀匹配（bylex）：<ul><li><code>zadd s 0 aaa 0 aab 0 abc</code></li><li>匹配aa开头的：<code>zrange s &quot;[aa&quot; &quot;[aa\xff&quot; bylex</code> &#x3D;&gt; <code>aaa aab</code>，redis对中文支持不太好，建议转成Unicode后处理</li></ul></li></ul></li></ul></li><li><strong>bitmap</strong>:位图。实现方式：字符串<ul><li>使用：布隆过滤器。需配合代码里的k个hash函数。具体来说，对于长度为m的bitmap b，每个hash函数计算后的值对m取模得到的一个位置坐标，将bitmap对应位置标记为1。布隆过滤器可以判断<strong>可能存在</strong>和<strong>一定不存在</strong>，不支持元素删除。</li></ul></li><li><strong>Geo</strong>：地理位置。实现方式：有序列表(<strong>ZSet</strong>)<ul><li>zset里每个member是地点的名称或id，score是经纬度经过GeoHash编码后的值</li><li>增加：<code>GEOADD cities 116.405285 39.904989 &quot;Beijing&quot;</code></li><li>查找附近: <code>GEORADIUS cities 116.405285 39.904989 100 km</code></li><li>计算距离: <code>GEODIST cities &quot;Beijing&quot; &quot;Shanghai&quot; km</code></li></ul></li></ul><h3 id="Redis过期策略"><a href="#Redis过期策略" class="headerlink" title="Redis过期策略"></a>Redis过期策略</h3><ul><li>定时删除<ul><li>默认每秒执行10次</li><li>贪心+随机删除</li></ul></li><li>惰性删除<ul><li>请求key时，发现过期，则删除，返回<code>null</code></li></ul></li></ul><h3 id="Redis内存淘汰策略"><a href="#Redis内存淘汰策略" class="headerlink" title="Redis内存淘汰策略"></a>Redis内存淘汰策略</h3><ul><li><strong>LRU</strong>：最少最近使用，删除访问时间最早的元素</li><li><strong>LFU</strong>：最少使用频率，删除访问频率最低的元素</li></ul><ol><li><code>noeviction</code>：只返回错误，不会删除任何key。该策略是Redis的<strong>默认淘汰策略</strong>，一般不会选用</li><li><code>volatile-ttl</code>：将设置了过期时间的key中即将过期（剩余存活时间最短）的key删除掉</li><li><code>volatile-random</code>：在设置了过期时间的key中，随机删除某个key</li><li><code>allkeys-random</code>：从所有key中随机删除某个key</li><li><code>volatile-lru</code>：基于LRU算法，从设置了过期时间的key中，删除掉最近最少使用的key</li><li><code>allkeys-lru</code>：基于LRU算法，从所有key中，删除掉最近最少使用的key。该策略是<strong>最常使用的策略</strong></li><li><code>volatile-lfu</code>：基于LFU算法，从设置了过期时间的key中，删除掉最不经常使用（使用次数最少）的key</li><li><code>allkeys-lfu</code>：基于LFU算法，从所有key中，删除掉最不经常使用（使用次数最少）的key</li></ol><h3 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h3><ul><li><strong>RDB</strong>：周期性保存快照。宕机时可以会丢数据<ul><li>适合冷备，体积小，恢复速度快</li><li>fork时如果数据量过大，则可能导致<strong>服务暂停</strong>或<strong>OOM</strong><ul><li>耗时与实例大小有关，控制redis内存在10G以内</li><li>虚拟机上 fork 的耗时比物理机更久</li></ul></li><li>二进制文件，不可读</li></ul></li><li><strong>AOF</strong>：将命令写入os cache，定时刷盘。数据更完整<ul><li><strong>rewirte</strong>：将大文件构造为小文件<ul><li>不影响服务</li></ul></li><li>同步磁盘策略：<code>everysec</code>、<code>always</code>、<code>no</code>（由操作系统执行）</li></ul></li></ul><h3 id="Redis高可用方案"><a href="#Redis高可用方案" class="headerlink" title="Redis高可用方案"></a>Redis高可用方案</h3><blockquote><p><a href="https://baijiahao.baidu.com/s?id=1729711337158702696">https://baijiahao.baidu.com/s?id=1729711337158702696</a></p></blockquote><h4 id="1-主从架构"><a href="#1-主从架构" class="headerlink" title="1. 主从架构"></a>1. 主从架构</h4><ul><li>仅数据同步</li><li>没有故障迁移功能，需手动迁移</li></ul><h4 id="2-哨兵模式（sentinel，基于主从架构）"><a href="#2-哨兵模式（sentinel，基于主从架构）" class="headerlink" title="2. 哨兵模式（sentinel，基于主从架构）"></a>2. 哨兵模式（sentinel，基于主从架构）</h4><ul><li><p>client连接哨兵，由哨兵返回master节点</p></li><li><p>当master不可用，sentinel返回给客户端slave地址</p></li><li><p>sentinel也可以是集群部署，当需要故障迁移时，需要先选出leader节点再由leader节点进行操作</p></li><li><p><strong>主观下线</strong>：redis节点不能及时正常响应sentinel的<code>PING</code>命令</p></li><li><p><strong>客观下线</strong>：redis master节点被足够多的sentinel标记为<strong>主观下线</strong></p></li></ul><h4 id="3-Redis-Cluster"><a href="#3-Redis-Cluster" class="headerlink" title="3. Redis Cluster"></a>3. Redis Cluster</h4><p>由多个redis节点组成，数据通过分片的形式保存在各个redis节点上</p><ul><li>当其中一个分片不可用时，整个集群将不可用</li><li>每个分片可以是主从架构，主节点故障时从节点可以接管，提高可用性。</li><li>至少部署6个节点（3主3从）</li></ul><h5 id="哈希槽"><a href="#哈希槽" class="headerlink" title="哈希槽"></a>哈希槽</h5><p>Redis集群有<code>16384</code>个哈希槽，进行<code>set</code>操作时，每个key会通过<code>CRC16</code>校验后再对<code>16384</code>取模来决定放置在哪个槽，搭建Redis集群时会先给集群中每个master节点分配一部分哈希槽</p><ul><li>每个节点都需要知道其他所有节点的状态信息</li></ul><h5 id="重定向MOVED"><a href="#重定向MOVED" class="headerlink" title="重定向MOVED"></a>重定向<code>MOVED</code></h5><p>由于每个节点都知道所有节点信息，所以client可以向任意redis master节点发送命令</p><p>如果key不在本机，则返回<code>MOVED</code>错误，格式为<code>MOVED [哈希槽] [IP:port]</code>（key所属的哈希槽和能处理这个请求的Redis节点的IP和端口号），客户端根据此重新发送命令</p><h3 id="Redis命令"><a href="#Redis命令" class="headerlink" title="Redis命令"></a>Redis命令</h3><ul><li>expire [key] [second]：当timeout为非正数时，key将被删除且发出key被删除事件</li></ul><blockquote><p>Note that calling EXPIRE&#x2F;PEXPIRE with a non-positive timeout or EXPIREAT&#x2F;PEXPIREAT with a time in the past will result in the key being deleted rather than expired (accordingly, the emitted key event will be del, not expired). <a href="https://redis.io/commands/expire/">https://redis.io/commands/expire/</a></p></blockquote><h3 id="Redis常见问题"><a href="#Redis常见问题" class="headerlink" title="Redis常见问题"></a>Redis常见问题</h3><h4 id="热点Key问题"><a href="#热点Key问题" class="headerlink" title="热点Key问题"></a>热点Key问题</h4><ul><li>本地缓存，使用Caffine等库。适用于不要求强一致性的场景</li><li>拆分key。需要提前知道哪些时热点key，并且客户端需要特殊处理</li><li>主从架构，从slave节点读取。同步延迟</li></ul><h4 id="大key删除"><a href="#大key删除" class="headerlink" title="大key删除"></a>大key删除</h4><ul><li>4.0.0以后，使用<code>unlink</code>代替<code>del</code></li><li>6.0.0以后，开启<code>lazyfree-lazy-user-del=yes</code>，这样<code>del</code>命令也会放到后台线程执行</li><li>设置过期时间，让redis在后台进行删除</li><li>将大 Key 分成多个小批次删除。也可以将下面的执行写成lua脚本执行<ul><li>对于Hash，使用hscan和hdel删除</li><li>对于Set，使用sscan和srem删除</li><li>对于List，使用lpop或rpop删除</li><li>对于ZSet，使用zscan和zrem删除</li></ul></li></ul><h3 id="Redis-7的ACL权限控制"><a href="#Redis-7的ACL权限控制" class="headerlink" title="Redis 7的ACL权限控制"></a>Redis 7的ACL权限控制</h3><ul><li>开启ACL: 编辑<code>redis.conf</code>文件，打开<code>aclfile /etc/redis/users.acl</code>，该文件需存在，否则启动报错</li><li>查看所有用户: <code>acl list</code>，默认有<code>default</code>用户</li><li>新增&#x2F;修改用户: <code>acl setuser [username] [on/off] &gt;[password] [~*] [+@all]</code><ul><li><code>~*</code>表示有权限key的正则表达式</li><li><code>+@all</code>表示操作权限</li></ul></li><li>保存修改: <code>acl save</code></li><li>使用: 连接后，默认是<code>default</code>用户，需先调用<code>auth [username] [password]</code>命令进行认证。</li></ul><div style="border-top:2px solid #eee;height:1px;margin:8px 0"></div><div class="article-category"><svg class="i-tag" width="16px" height="16px" viewBox="0 0 24 24" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.41959 3.23866C6.23018 3.05852 7.19557 3 8.312 3H9.92963C10.9327 3 11.8694 3.5013 12.4258 4.3359L13.2383 5.5547C13.4238 5.83288 13.736 6 14.0704 6H19.1258C20.7233 6 22.0181 7.26115 22.0029 8.8852C21.9847 10.8192 22 12.7539 22 14.688C22 15.8044 21.9415 16.7698 21.7613 17.5804C21.5787 18.4024 21.2579 19.1251 20.6915 19.6915C20.1251 20.2579 19.4024 20.5787 18.5804 20.7613C17.7698 20.9415 16.8044 21 15.688 21H8.312C7.19557 21 6.23018 20.9415 5.41959 20.7613C4.59764 20.5787 3.87488 20.2579 3.30848 19.6915C2.74209 19.1251 2.42133 18.4024 2.23866 17.5804C2.05852 16.7698 2 15.8044 2 14.688V9.312C2 8.19557 2.05852 7.23018 2.23866 6.41959C2.42133 5.59764 2.74209 4.87488 3.30848 4.30848C3.87488 3.74209 4.59764 3.42133 5.41959 3.23866ZM8.19103 13.8535C8.05868 14.449 8 15.2412 8 16.312V18C8 18.5523 7.55228 19 7 19C6.44772 19 6 18.5523 6 18V16.312C6 15.1956 6.05852 14.2302 6.23866 13.4196C6.42133 12.5976 6.74209 11.8749 7.30848 11.3085C7.87488 10.7421 8.59764 10.4213 9.41959 10.2387C10.2302 10.0585 11.1956 10 12.312 10H17.688H19C19.5523 10 20 10.4477 20 11C20 11.5523 19.5523 12 19 12H17.688H12.312C11.2412 12 10.449 12.0587 9.85349 12.191C9.26933 12.3209 8.9375 12.5079 8.72269 12.7227C8.50789 12.9375 8.32085 13.2693 8.19103 13.8535Z"/></svg> &nbsp; <a class="article-category-link" href="/category/technology/">技术</a>&nbsp;/&nbsp;<a class="article-category-link" href="/category/technology/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></div><div class="article-tag"><svg class="i-tag" width="16" height="16" viewBox="0 0 24 24" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2.678 11.422a2.5 2.5 0 0 0 0 3.536l6.364 6.364a2.5 2.5 0 0 0 3.536 0l7.69-7.69A2.5 2.5 0 0 0 21 11.864V4.5A1.5 1.5 0 0 0 19.5 3h-7.365a2.5 2.5 0 0 0-1.768.732l-7.69 7.69zM14.988 7C13.878 7 13 7.832 13 8.988c0 1.157.878 2.012 1.988 2.012C16.121 11 17 10.145 17 8.988 17 7.832 16.12 7 14.988 7z"/></svg> &nbsp; <a class="article-tag-link" href="/tags/Redis/" rel="tag">Redis</a>, <a class="article-tag-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">缓存</a>, <a class="article-tag-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></div><div class="article-date"><time datetime="2023-03-14T08:00:00.000Z" itemprop="datePublished">2023-03-14</time></div></article></body></html>