<!DOCTYPE html><html><head><meta charset="utf-8"><title>Alibaba的TransmittableThreadLocal | 曹耘豪的博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="alternate" href="/atom.xml" title="曹耘豪的博客" type="application/atom+xml"><link rel="icon" href="https://s1.ax1x.com/2018/06/09/CbgQqs.png"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="header2" style="border-bottom:1px solid #ccc"><input type="checkbox" id="header-menu-input"><h1 style="text-align:left"><a href="/">曹耘豪的博客</a> <label for="header-menu-input"><svg class="op open" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0 0 50 50" fill="currentcolor" stroke="currentcolor"><path d="M 0 7.5 L 0 12.5 L 50 12.5 L 50 7.5 Z M 0 22.5 L 0 27.5 L 50 27.5 L 50 22.5 Z M 0 37.5 L 0 42.5 L 50 42.5 L 50 37.5 Z"></path></svg> <svg class="close" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0 0 30 30" style="fill:red"><path d="M 7 4 C 6.744125 4 6.4879687 4.0974687 6.2929688 4.2929688 L 4.2929688 6.2929688 C 3.9019687 6.6839688 3.9019687 7.3170313 4.2929688 7.7070312 L 11.585938 15 L 4.2929688 22.292969 C 3.9019687 22.683969 3.9019687 23.317031 4.2929688 23.707031 L 6.2929688 25.707031 C 6.6839688 26.098031 7.3170313 26.098031 7.7070312 25.707031 L 15 18.414062 L 22.292969 25.707031 C 22.682969 26.098031 23.317031 26.098031 23.707031 25.707031 L 25.707031 23.707031 C 26.098031 23.316031 26.098031 22.682969 25.707031 22.292969 L 18.414062 15 L 25.707031 7.7070312 C 26.098031 7.3170312 26.098031 6.6829688 25.707031 6.2929688 L 23.707031 4.2929688 C 23.316031 3.9019687 22.682969 3.9019687 22.292969 4.2929688 L 15 11.585938 L 7.7070312 4.2929688 C 7.5115312 4.0974687 7.255875 4 7 4 z"></path></svg></label> <input disabled id="local-search-input" class="input-text" type="search" placeholder="js未开启，无法搜索" aria-label="Search"></h1><div id="local-search-result"></div><div class="header-menu" for="header-menu-input"><aside id="sidebar"><div><div class="widget-wrap widget-category"><h3 class="widget-title">目录</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/category/other/">其他</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/">技术</a><span class="category-list-count">137</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/category/technology/cpp/">C++</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/Go/">Go</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/java/">Java</a><span class="category-list-count">59</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/python/">Python</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/Rust/">Rust</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E5%89%8D%E7%AB%AF/">前端</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/machine-learning/">机器学习</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/computer-network/">计算机网络</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/design-pattern/">设计模式</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E8%AF%B4%E8%AF%B4/">说说</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/category/technology/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">13</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/category/algorithm/">算法</a><span class="category-list-count">8</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">MySQL</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Protobuf/" rel="tag">Protobuf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Cloud/" rel="tag">Spring Cloud</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Feign/" rel="tag">Feign</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" rel="tag">问题排查</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nextjs/" rel="tag">Nextjs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">Spring</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/" rel="tag">JVM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%90%86/" rel="tag">代理</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gradle/" rel="tag">Gradle</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maven/" rel="tag">Maven</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fastjson/" rel="tag">fastjson</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/" rel="tag">node</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm/" rel="tag">npm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">缓存</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hive/" rel="tag">Hive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8B%E8%AF%95/" rel="tag">测试</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/" rel="tag">HBase</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/" rel="tag">响应式编程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">其他</h3><div class="widget"><a href="/atom.xml">RSS Feed </a><a href="/resume" style="margin-left:8px">Resume</a></div></div></div></aside></div><script src="/js/search.js"></script><script type="text/javascript">(()=>{var e="local-search-input",a=(($input=document.getElementById(e)).disabled=!1,$input.placeholder="全站本地搜索","search.json"),a="/"+(a=0===a.length?"search.json":a);searchFunc(a,e,"local-search-result")})()</script></div><article id="post-cf119d50" class="article article-type-post" itemscope itemprop="blogPost" style="position:relative"><header><h1 class="article-title" itemprop="name">Alibaba的TransmittableThreadLocal</h1></header><div class="secondary-bg" style="border:1px solid gray;border-radius:4px"><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#TransmittableThreadLocal%E7%89%B9%E6%80%A7"><span class="toc-nav-text">TransmittableThreadLocal特性</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%85%88%E7%9C%8B%E7%9C%8BInheritableThreadLocal%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-nav-text">先看看InheritableThreadLocal的实现</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%A1%88%E4%BE%8B%E5%AF%B9%E6%AF%94"><span class="toc-nav-text">案例对比</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link"><span class="toc-nav-text"></span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#new-Thread-InheritableThreadLocal%EF%BC%8C%E5%8F%AF%E5%8F%96%E5%88%B0"><span class="toc-nav-text">new Thread() + InheritableThreadLocal，可取到</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0-InheritableThreadLocal%EF%BC%8C%E4%B8%8D%E5%8F%AF%E5%8F%96%E5%88%B0"><span class="toc-nav-text">线程池 + InheritableThreadLocal，不可取到</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#new-Thread-TransmittableThreadLocal%EF%BC%8C%E5%92%8CInheritableThreadLocal%E4%B8%80%E8%87%B4"><span class="toc-nav-text">new Thread() + TransmittableThreadLocal，和InheritableThreadLocal一致</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%8E%9F%E7%94%9F%E7%BA%BF%E7%A8%8B%E6%B1%A0-TransmittableThreadLocal%EF%BC%8C%E4%B8%8D%E5%8F%AF%E5%8F%96%E5%88%B0"><span class="toc-nav-text">原生线程池 + TransmittableThreadLocal，不可取到</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#TTL%E5%8C%85%E8%A3%85%E5%99%A8%E7%BA%BF%E7%A8%8B%E6%B1%A0-TransmittableThreadLocal%EF%BC%8C%E5%8F%AF%E5%8F%96%E5%88%B0"><span class="toc-nav-text">TTL包装器线程池 + TransmittableThreadLocal，可取到</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%A4%A7%E8%87%B4%E5%8E%9F%E7%90%86"><span class="toc-nav-text">大致原理</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95%E8%A7%A3%E9%87%8A"><span class="toc-nav-text">核心方法解释</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%85%B6%E4%BB%96%E7%89%B9%E6%80%A7"><span class="toc-nav-text">其他特性</span></a></li></ol></div><span id="more"></span><h3 id="TransmittableThreadLocal特性"><a href="#TransmittableThreadLocal特性" class="headerlink" title="TransmittableThreadLocal特性"></a>TransmittableThreadLocal特性</h3><ul><li>由于基于<code>InheritableThreadLocal</code>，可以在当前线程直接新建线程的场景，继承<code>ThreadLocal</code>值</li><li>配合<code>ExecutorServiceTtlWrapper</code>，可以在使用线程池的场景，继承<code>ThreadLocal</code>值</li></ul><h3 id="先看看InheritableThreadLocal的实现"><a href="#先看看InheritableThreadLocal的实现" class="headerlink" title="先看看InheritableThreadLocal的实现"></a>先看看InheritableThreadLocal的实现</h3><ul><li>线程Thread初始化时有一个<code>boolean inheritThreadLocals</code>参数，用于是否继承父线程的ThreadLocals值，默认true</li><li>在线程初始化时即完成继承，后续父线程修改也不会影响到当前线程</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != <span class="literal">null</span>)</span><br><span class="line">    <span class="built_in">this</span>.inheritableThreadLocals =</span><br><span class="line">        ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span><br></pre></td></tr></table></figure><h3 id="案例对比"><a href="#案例对比" class="headerlink" title="案例对比"></a>案例对比</h3><h4><a href="#" class="headerlink"></a></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inheritThreadLocals</span><br></pre></td></tr></table></figure><h4 id="new-Thread-InheritableThreadLocal，可取到"><a href="#new-Thread-InheritableThreadLocal，可取到" class="headerlink" title="new Thread() + InheritableThreadLocal，可取到"></a>new Thread() + InheritableThreadLocal，可取到</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">InheritableThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;&gt;();</span><br><span class="line">threadLocal.set(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;System.out.println(threadLocal.get());&#125;).start();</span><br><span class="line"><span class="comment">// 输出a</span></span><br></pre></td></tr></table></figure><h4 id="线程池-InheritableThreadLocal，不可取到"><a href="#线程池-InheritableThreadLocal，不可取到" class="headerlink" title="线程池 + InheritableThreadLocal，不可取到"></a>线程池 + InheritableThreadLocal，不可取到</h4><ul><li>原因：线程初始化没有ThreadLocal信息</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 先初始化进程，确保线程初始化时上下文中没有ThreadLocal信息</span></span><br><span class="line">executor.submit(() -&gt; &#123;System.out.println(<span class="string">&quot;init&quot;</span>);&#125;).get();</span><br><span class="line"></span><br><span class="line">InheritableThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;&gt;();</span><br><span class="line">threadLocal.set(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">executor.execute(() -&gt; &#123;System.out.println(threadLocal.get());&#125;);</span><br><span class="line"><span class="comment">// 输出null</span></span><br></pre></td></tr></table></figure><h4 id="new-Thread-TransmittableThreadLocal，和InheritableThreadLocal一致"><a href="#new-Thread-TransmittableThreadLocal，和InheritableThreadLocal一致" class="headerlink" title="new Thread() + TransmittableThreadLocal，和InheritableThreadLocal一致"></a>new Thread() + TransmittableThreadLocal，和InheritableThreadLocal一致</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TransmittableThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line">threadLocal.set(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;System.out.println(threadLocal.get());&#125;).start();</span><br><span class="line"><span class="comment">// 输出a</span></span><br></pre></td></tr></table></figure><h4 id="原生线程池-TransmittableThreadLocal，不可取到"><a href="#原生线程池-TransmittableThreadLocal，不可取到" class="headerlink" title="原生线程池 + TransmittableThreadLocal，不可取到"></a>原生线程池 + TransmittableThreadLocal，不可取到</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 先初始化进程，确保线程初始化时上下文中没有ThreadLocal信息</span></span><br><span class="line">executor.submit(() -&gt; &#123;System.out.println(<span class="string">&quot;init&quot;</span>);&#125;).get(); </span><br><span class="line"></span><br><span class="line">TransmittableThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line">threadLocal.set(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">executor.execute(() -&gt; &#123;System.out.println(threadLocal.get());&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">// init</span></span><br><span class="line"><span class="comment">// null</span></span><br></pre></td></tr></table></figure><h4 id="TTL包装器线程池-TransmittableThreadLocal，可取到"><a href="#TTL包装器线程池-TransmittableThreadLocal，可取到" class="headerlink" title="TTL包装器线程池 + TransmittableThreadLocal，可取到"></a>TTL包装器线程池 + TransmittableThreadLocal，可取到</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> TtlExecutors.getTtlExecutorService(Executors.newFixedThreadPool(<span class="number">1</span>));</span><br><span class="line"><span class="comment">// 先初始化进程，确保线程初始化时上下文中没有ThreadLocal信息</span></span><br><span class="line">executor.submit(() -&gt; &#123;System.out.println(<span class="string">&quot;init&quot;</span>);&#125;).get(); </span><br><span class="line"></span><br><span class="line">TransmittableThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line">threadLocal.set(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">executor.execute(() -&gt; &#123;System.out.println(threadLocal.get());&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">// init</span></span><br><span class="line"><span class="comment">// a</span></span><br></pre></td></tr></table></figure><h3 id="大致原理"><a href="#大致原理" class="headerlink" title="大致原理"></a>大致原理</h3><ul><li><p>包装器<code>ExecutorServiceTtlWrapper</code>在<code>submit</code>等相关方法时，将<code>Runnable</code>包装为<code>TtlRunnable</code></p></li><li><p><code>TtlRunnable</code>初始化时保存当前线程的所有<code>TransmittableThreadLocal</code>上下文（<code>capture</code>），在执行<code>run</code>方法时，先设置这些上下文（<code>replay</code>），再执行业务代码，最后在<code>finally</code>里恢复执行前的状态（<code>restore</code>）</p></li><li><p><code>TransmittableThreadLocal</code>在执行<code>set</code>时，会将当前<code>TransmittableThreadLocal</code>添加到线程的holder内，意味着该线程以及该线程在使用线程池时，需要该<code>ThreadLocal</code></p></li></ul><h4 id="核心方法解释"><a href="#核心方法解释" class="headerlink" title="核心方法解释"></a>核心方法解释</h4><ul><li><code>capture</code>：在第一个线程执行，保存当前线程的holder中，每个<code>TransmittableThreadLocal</code>和值的mapping，提供一个ref</li><li><code>replay</code>：在第二个线程执行，通过ref，重新在当前线程设置<code>capture</code>中的值，方法返回设置前holder内的值mapping作为<strong>backup</strong></li><li><code>restore</code>：使用backup恢复状态</li></ul><h3 id="其他特性"><a href="#其他特性" class="headerlink" title="其他特性"></a>其他特性</h3><ul><li>线程间传递值时，可自定义copy方式，默认直接传递引用</li><li>使用<code>TransmittableThreadLocal.Transmitter.registerThreadLocal(ThreadLocal,TtlCopier)</code>方法，将现有<code>ThreadLocal</code>也能支持该特性</li></ul><div style="border-top:2px solid #eee;height:1px;margin:8px 0"></div><div class="article-category"><svg class="i-tag" width="16px" height="16px" viewBox="0 0 24 24" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.41959 3.23866C6.23018 3.05852 7.19557 3 8.312 3H9.92963C10.9327 3 11.8694 3.5013 12.4258 4.3359L13.2383 5.5547C13.4238 5.83288 13.736 6 14.0704 6H19.1258C20.7233 6 22.0181 7.26115 22.0029 8.8852C21.9847 10.8192 22 12.7539 22 14.688C22 15.8044 21.9415 16.7698 21.7613 17.5804C21.5787 18.4024 21.2579 19.1251 20.6915 19.6915C20.1251 20.2579 19.4024 20.5787 18.5804 20.7613C17.7698 20.9415 16.8044 21 15.688 21H8.312C7.19557 21 6.23018 20.9415 5.41959 20.7613C4.59764 20.5787 3.87488 20.2579 3.30848 19.6915C2.74209 19.1251 2.42133 18.4024 2.23866 17.5804C2.05852 16.7698 2 15.8044 2 14.688V9.312C2 8.19557 2.05852 7.23018 2.23866 6.41959C2.42133 5.59764 2.74209 4.87488 3.30848 4.30848C3.87488 3.74209 4.59764 3.42133 5.41959 3.23866ZM8.19103 13.8535C8.05868 14.449 8 15.2412 8 16.312V18C8 18.5523 7.55228 19 7 19C6.44772 19 6 18.5523 6 18V16.312C6 15.1956 6.05852 14.2302 6.23866 13.4196C6.42133 12.5976 6.74209 11.8749 7.30848 11.3085C7.87488 10.7421 8.59764 10.4213 9.41959 10.2387C10.2302 10.0585 11.1956 10 12.312 10H17.688H19C19.5523 10 20 10.4477 20 11C20 11.5523 19.5523 12 19 12H17.688H12.312C11.2412 12 10.449 12.0587 9.85349 12.191C9.26933 12.3209 8.9375 12.5079 8.72269 12.7227C8.50789 12.9375 8.32085 13.2693 8.19103 13.8535Z"/></svg> &nbsp; <a class="article-category-link" href="/category/technology/">技术</a>&nbsp;/&nbsp;<a class="article-category-link" href="/category/technology/java/">Java</a></div><div class="article-date"><time datetime="2024-02-04T08:00:00.000Z" itemprop="datePublished">2024-02-04</time></div></article></body></html>